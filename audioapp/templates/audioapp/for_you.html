{% extends 'base.html' %}

{% block content %}
    <h1>For You</h1>
    {% if audio_file %}
        <h2 id="audio-title">{{ audio_file.title }}</h2>
        <p id="audio-description">{{ audio_file.description }}</p>
        <p id="audio-like-count">{{ audio_file.like_count }} Likes</p>
        
        <button id="like-button" data-audio-id="{{ audio_file.id }}" data-action="like">
            Like
        </button>

        <p id="audio-username">By {{ audio_file.user.username }}</p>
        <audio controls id="audio-player" autoplay>
            <source id="audio-source" src="{{ audio_file.file.url }}" type="audio/mp4">
            Your browser does not support the audio element.
        </audio>
        <button id="previous-button" {% if fyp_index <= 0 %}disabled{% endif %}>Previous</button>
        <button id="next-button" {% if reached_end %}disabled{% endif %}>Next</button>
        <label>
            <input type="checkbox" id="autoplay-checkbox" {% if autoplay %}checked{% endif %}> Autoplay
        </label>

        <form id="comment-form" method="post" action="{% url 'for_you' %}">
            {% csrf_token %}
            {{ comment_form.as_p }}
            <button type="submit" name="action" value="comment">Add Comment</button>
        </form>
        <ul id="comments-list">
            {% for comment in comments %}
                <li>{{ comment.user.username }}: {{ comment.text }}</li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No audio files available.</p>
    {% endif %}

    <script>
        function getAudio(action) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '{% url "for_you" %}?action=' + action, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var data = JSON.parse(xhr.responseText);
                    document.getElementById('audio-title').textContent = data.title;
                    document.getElementById('audio-description').textContent = data.description;
                    document.getElementById('audio-like-count').textContent = data.like_count + ' Likes';
                    document.getElementById('audio-username').textContent = 'By ' + data.username;
                    document.getElementById('audio-source').src = data.audio_file_url;
                    var audioPlayer = document.getElementById('audio-player');
                    audioPlayer.load();
                    if (document.getElementById('autoplay-checkbox').checked) {
                        audioPlayer.play();
                    }
                    document.getElementById('previous-button').disabled = data.fyp_index <= 0;
                    document.getElementById('next-button').disabled = data.reached_end;
                    if (data.reached_end) {
                        document.getElementById('autoplay-checkbox').checked = false;
                    }
                    var commentsList = document.getElementById('comments-list');
                    commentsList.innerHTML = '';
                    data.comments.forEach(function(comment) {
                        var li = document.createElement('li');
                        li.textContent = comment.user + ': ' + comment.text;
                        commentsList.appendChild(li);
                    });
                }
            };
            xhr.send();
        }

        function postAudio(action, formData = null) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '{% url "for_you" %}?action=' + action, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var data = JSON.parse(xhr.responseText);
                    document.getElementById('audio-title').textContent = data.title;
                    document.getElementById('audio-description').textContent = data.description;
                    document.getElementById('audio-like-count').textContent = data.like_count + ' Likes';
                    document.getElementById('audio-username').textContent = 'By ' + data.username;
                    document.getElementById('audio-source').src = data.audio_file_url;
                    var audioPlayer = document.getElementById('audio-player');
                    audioPlayer.load();
                    if (document.getElementById('autoplay-checkbox').checked) {
                        audioPlayer.play();
                    }
                    document.getElementById('previous-button').disabled = data.fyp_index <= 0;
                    document.getElementById('next-button').disabled = data.reached_end;
                    if (data.reached_end) {
                        document.getElementById('autoplay-checkbox').checked = false;
                    }

                    var commentsList = document.getElementById('comments-list');
                    commentsList.innerHTML = '';
                    data.comments.forEach(function(comment) {
                        var li = document.createElement('li');
                        li.textContent = comment.user + ': ' + comment.text;
                        commentsList.appendChild(li);
                    });
                }
            };
                xhr.send(formData);
        }


        document.getElementById('previous-button').addEventListener('click', function() {
            getAudio('previous');
        });

        document.getElementById('next-button').addEventListener('click', function() {
            getAudio('next');
        });

        document.getElementById('audio-player').addEventListener('ended', function() {
            if (document.getElementById('autoplay-checkbox').checked) {
                getAudio('next');
            }
        });

        
        document.getElementById('like-button').addEventListener('click', function() {
            event.preventDefault();
            var formData = new FormData();
            formData.append('action', 'like');
            postAudio('like', formData);
        });

        document.getElementById('comment-form').addEventListener('submit', function(event) {
            event.preventDefault();
            var formData = new FormData(this);
            formData.append('action', 'comment');
            postAudio('comment', formData);
        });
        

        document.getElementById('autoplay-checkbox').addEventListener('change', function() {
            var isChecked = this.checked;
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '{% url "update_autoplay" %}?autoplay=' + isChecked, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.send();
        });
    </script>
{% endblock %}

