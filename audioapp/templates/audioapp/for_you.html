{% extends 'base.html' %}

{% block content %}
    <h1>For You</h1>
    {% if audio_file %}
        <h2 id="audio-title">{{ audio_file.title }}</h2>
        <p id="audio-description">{{ audio_file.description }}</p>
        <p>By {{ audio_file.user.username }}</p>
        <audio controls id="audio-player" autoplay>
            <source id="audio-source" src="{{ audio_file.file.url }}" type="audio/mp4">
            Your browser does not support the audio element.
        </audio>
        <button id="previous-button" {% if fyp_index <= 0 %}disabled{% endif %}>Previous</button>
        <button id="next-button" {% if reached_end %}disabled{% endif %}>Next</button>
        <label>
            <input type="checkbox" id="autoplay-checkbox" {% if autoplay %}checked{% endif %}> Autoplay
        </label>
    {% else %}
        <p>No audio files available.</p>
    {% endif %}

    <script>
        function updateAudio(action) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '{% url "for_you" %}?action=' + action, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var data = JSON.parse(xhr.responseText);
                    document.getElementById('audio-title').textContent = data.title;
                    document.getElementById('audio-description').textContent = data.description;
                    document.getElementById('audio-source').src = data.audio_file_url;
                    var audioPlayer = document.getElementById('audio-player');
                    audioPlayer.load();
                    if (document.getElementById('autoplay-checkbox').checked) {
                        audioPlayer.play();
                    }
                    document.getElementById('previous-button').disabled = data.fyp_index <= 0;
                    document.getElementById('next-button').disabled = data.reached_end;
                    if (data.reached_end) {
                        document.getElementById('autoplay-checkbox').checked = false;
                    }
                }
            };
            xhr.send();
        }

        document.getElementById('previous-button').addEventListener('click', function() {
            updateAudio('previous');
        });

        document.getElementById('next-button').addEventListener('click', function() {
            updateAudio('next');
        });

        document.getElementById('audio-player').addEventListener('ended', function() {
            if (document.getElementById('autoplay-checkbox').checked) {
                updateAudio('next');
            }
        });

        document.getElementById('autoplay-checkbox').addEventListener('change', function() {
            var isChecked = this.checked;
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '{% url "update_autoplay" %}?autoplay=' + isChecked, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.send();
        });
    </script>
{% endblock %}

